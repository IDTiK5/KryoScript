local HttpService = game:GetService("HttpService")
local Players     = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")

-- === CONFIG ===
local ServiceIdentifier = "kryoscript"
local ConfigFileName = "KryoScript_Config.json"

-- STATE VARIABLES
local storedKey = ""
local guiCreated = false

-- === FUNCTION DEFINITIONS ===
local function ValidateKey(key, serviceId, hwid)
    local url = "https://pandadevelopment.net/v2_validation?key=" 
              .. tostring(key) 
              .. "&service=" .. tostring(serviceId)
              .. "&hwid=" .. tostring(hwid)
    local success, response = pcall(function()
        return HttpService:RequestAsync({
            Url = url,
            Method = "GET"
        })
    end)

    if not success or not response then
        warn("[Auth] HTTP failed:", response)
        return false, "HTTP fail"
    end

    if response.Success then
        local parsed, data = pcall(function()
            return HttpService:JSONDecode(response.Body)
        end)
        if not parsed or not data then
            warn("[Auth] JSON decode failed")
            return false, "JSON decode fail"
        end

        if data["V2_Authentication"] == "success" then
            print("[Auth] Key Validated Successfully")
            return true, "success"
        else
            local reason = data["reason"] or "unknown"
            warn("[Auth] Auth failed:", reason)
            return false, reason
        end
    else
        warn("[Auth] HTTP response not success:", response.StatusCode)
        return false, "not success"
    end
end

local function GetKeyLink(serviceId, hwid)
    return "https://pandadevelopment.net/getkey?service=" 
         .. tostring(serviceId) 
         .. "&hwid=" .. tostring(hwid)
end

local function SaveConfig(key)
    if not writefile then return end
    
    local data = {
        Key = key
    }
    
    pcall(function()
        writefile(ConfigFileName, HttpService:JSONEncode(data))
    end)
end

local function LoadConfig()
    if not readfile or not isfile then return nil end
    if not isfile(ConfigFileName) then return nil end
    
    local success, result = pcall(function()
        return HttpService:JSONDecode(readfile(ConfigFileName))
    end)
    
    if success then return result end
    return nil
end

local function ShowLoadingScreen()
    local LoadingGui = Instance.new("ScreenGui")
    LoadingGui.Name = "LoadingScreen"
    LoadingGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    LoadingGui.IgnoreGuiInset = true
    LoadingGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local LoadingBg = Instance.new("Frame")
    LoadingBg.Size = UDim2.new(1, 0, 1, 0)
    LoadingBg.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
    LoadingBg.BorderSizePixel = 0
    LoadingBg.Parent = LoadingGui

    local LoadingContainer = Instance.new("Frame")
    LoadingContainer.Size = UDim2.new(0, 100, 0, 100)
    LoadingContainer.Position = UDim2.new(0.5, -50, 0.5, -50)
    LoadingContainer.BackgroundTransparency = 1
    LoadingContainer.Parent = LoadingBg

    local Dot1 = Instance.new("Frame")
    Dot1.Size = UDim2.new(0, 12, 0, 12)
    Dot1.Position = UDim2.new(0, 10, 0.5, -6)
    Dot1.BackgroundColor3 = Color3.fromRGB(99, 102, 241)
    Dot1.BorderSizePixel = 0
    Dot1.Parent = LoadingContainer
    local Corner1 = Instance.new("UICorner")
    Corner1.CornerRadius = UDim.new(1, 0)
    Corner1.Parent = Dot1

    local Dot2 = Instance.new("Frame")
    Dot2.Size = UDim2.new(0, 12, 0, 12)
    Dot2.Position = UDim2.new(0.5, -6, 0.5, -6)
    Dot2.BackgroundColor3 = Color3.fromRGB(168, 85, 247)
    Dot2.BorderSizePixel = 0
    Dot2.Parent = LoadingContainer
    local Corner2 = Instance.new("UICorner")
    Corner2.CornerRadius = UDim.new(1, 0)
    Corner2.Parent = Dot2

    local Dot3 = Instance.new("Frame")
    Dot3.Size = UDim2.new(0, 12, 0, 12)
    Dot3.Position = UDim2.new(1, -22, 0.5, -6)
    Dot3.BackgroundColor3 = Color3.fromRGB(99, 102, 241)
    Dot3.BorderSizePixel = 0
    Dot3.Parent = LoadingContainer
    local Corner3 = Instance.new("UICorner")
    Corner3.CornerRadius = UDim.new(1, 0)
    Corner3.Parent = Dot3

    local function AnimateDot(dot, delay)
        task.spawn(function()
            while LoadingGui.Parent do
                task.wait(delay)
                TweenService:Create(dot, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                    Position = UDim2.new(dot.Position.X.Scale, dot.Position.X.Offset, 0.5, -18)
                }):Play()
                task.wait(0.3)
                TweenService:Create(dot, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
                    Position = UDim2.new(dot.Position.X.Scale, dot.Position.X.Offset, 0.5, -6)
                }):Play()
                task.wait(0.3)
            end
        end)
    end

    AnimateDot(Dot1, 0)
    AnimateDot(Dot2, 0.15)
    AnimateDot(Dot3, 0.3)

    return LoadingGui
end

-- === COLOR PALETTE ===
local Colors = {
    Background = Color3.fromRGB(15, 15, 20),
    Card = Color3.fromRGB(25, 25, 35),
    CardLight = Color3.fromRGB(35, 35, 48),
    Primary = Color3.fromRGB(99, 102, 241),
    PrimaryHover = Color3.fromRGB(129, 140, 248),
    Secondary = Color3.fromRGB(45, 45, 60),
    SecondaryHover = Color3.fromRGB(55, 55, 75),
    Text = Color3.fromRGB(245, 245, 250),
    TextMuted = Color3.fromRGB(160, 160, 180),
    Success = Color3.fromRGB(34, 197, 94),
    Error = Color3.fromRGB(239, 68, 68),
    Border = Color3.fromRGB(55, 55, 75),
    Accent = Color3.fromRGB(168, 85, 247),
    Facebook = Color3.fromRGB(24, 119, 242),
    Discord = Color3.fromRGB(88, 101, 242),
}

-- === CREATE GUI FUNCTION ===
local function CreateUI()
    if guiCreated then return end
    guiCreated = true
    
    local LoadingScreen = ShowLoadingScreen()

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "ModernKeyAuthUI"
    ScreenGui.Parent = game:GetService("CoreGui")  -- ƒê·∫∑t v√†o CoreGui thay v√¨ PlayerGui
    ScreenGui.IgnoreGuiInset = true
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local Overlay = Instance.new("Frame")
    Overlay.Name = "Overlay"
    Overlay.Size = UDim2.new(1, 0, 1, 0)
    Overlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    Overlay.BackgroundTransparency = 1
    Overlay.BorderSizePixel = 0
    Overlay.Parent = ScreenGui

    local Blur = Instance.new("BlurEffect")
    Blur.Name = "AuthBlur"
    Blur.Size = 0
    Blur.Parent = Lighting

    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Size = UDim2.new(0, 420, 0, 440)
    MainFrame.Position = UDim2.new(0.5, -202, 0.516, -220)
    MainFrame.BackgroundColor3 = Colors.Card
    MainFrame.BorderSizePixel = 0
    MainFrame.BackgroundTransparency = 0
    MainFrame.Active = true
    MainFrame.Parent = ScreenGui

    local MainCorner = Instance.new("UICorner")
    MainCorner.CornerRadius = UDim.new(0, 20)
    MainCorner.Parent = MainFrame

    local MainStroke = Instance.new("UIStroke")
    MainStroke.Color = Colors.Border
    MainStroke.Thickness = 1
    MainStroke.Transparency = 0
    MainStroke.Parent = MainFrame

    local GradientFrame = Instance.new("Frame")
    GradientFrame.Name = "GradientOverlay"
    GradientFrame.Size = UDim2.new(1, 0, 0.4, 0)
    GradientFrame.Position = UDim2.new(0, 0, 0, 0)
    GradientFrame.BackgroundTransparency = 0.85
    GradientFrame.BorderSizePixel = 0
    GradientFrame.Parent = MainFrame
    GradientFrame.ZIndex = 0

    local GradientCorner = Instance.new("UICorner")
    GradientCorner.CornerRadius = UDim.new(0, 20)
    GradientCorner.Parent = GradientFrame

    local TopGradient = Instance.new("UIGradient")
    TopGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Colors.Primary),
        ColorSequenceKeypoint.new(1, Colors.Accent)
    }
    TopGradient.Rotation = 45
    TopGradient.Transparency = NumberSequence.new{
        NumberSequenceKeypoint.new(0, 0),
        NumberSequenceKeypoint.new(1, 1)
    }
    TopGradient.Parent = GradientFrame

    local Header = Instance.new("Frame")
    Header.Name = "Header"
    Header.Size = UDim2.new(1, 0, 0, 70)
    Header.BackgroundTransparency = 1
    Header.Parent = MainFrame

    local IconFrame = Instance.new("Frame")
    IconFrame.Name = "IconFrame"
    IconFrame.Size = UDim2.new(0, 44, 0, 44)
    IconFrame.Position = UDim2.new(0, 24, 0.5, -22)
    IconFrame.BackgroundColor3 = Colors.Primary
    IconFrame.BorderSizePixel = 0
    IconFrame.Parent = Header

    local IconCorner = Instance.new("UICorner")
    IconCorner.CornerRadius = UDim.new(0, 12)
    IconCorner.Parent = IconFrame

    local IconGradient = Instance.new("UIGradient")
    IconGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Colors.Primary),
        ColorSequenceKeypoint.new(1, Colors.Accent)
    }
    IconGradient.Rotation = 135
    IconGradient.Parent = IconFrame

    local IconSymbol = Instance.new("TextLabel")
    IconSymbol.Name = "Symbol"
    IconSymbol.Size = UDim2.new(1, 0, 1, 0)
    IconSymbol.BackgroundTransparency = 1
    IconSymbol.Text = "üîê"
    IconSymbol.TextSize = 22
    IconSymbol.Font = Enum.Font.GothamBold
    IconSymbol.Parent = IconFrame

    local Title = Instance.new("TextLabel")
    Title.Name = "Title"
    Title.Size = UDim2.new(0, 200, 0, 24)
    Title.Position = UDim2.new(0, 80, 0, 15)
    Title.BackgroundTransparency = 1
    Title.Text = "X√°c th·ª±c Kho√°"
    Title.TextColor3 = Colors.Text
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.Font = Enum.Font.GothamBlack
    Title.TextSize = 20
    Title.Parent = Header

    local Subtitle = Instance.new("TextLabel")
    Subtitle.Name = "Subtitle"
    Subtitle.Size = UDim2.new(0, 200, 0, 18)
    Subtitle.Position = UDim2.new(0, 80, 0, 42)
    Subtitle.BackgroundTransparency = 1
    Subtitle.Text = "Nh·∫≠p kho√° c·ªßa b·∫°n ƒë·ªÉ ch·∫°y scripts!"
    Subtitle.TextColor3 = Colors.TextMuted
    Subtitle.TextXAlignment = Enum.TextXAlignment.Left
    Subtitle.Font = Enum.Font.GothamMedium
    Subtitle.TextSize = 12
    Subtitle.Parent = Header

    local CloseBtn = Instance.new("ImageButton")
    CloseBtn.Name = "CloseBtn"
    CloseBtn.Size = UDim2.new(0, 32, 0, 32)
    CloseBtn.Position = UDim2.new(1, -48, 0.5, -16)
    CloseBtn.BackgroundColor3 = Colors.Secondary
    CloseBtn.BackgroundTransparency = 1
    CloseBtn.BorderSizePixel = 0
    CloseBtn.Image = "rbxasset://textures/Cursor.png"
    CloseBtn.Parent = Header

    local CloseBtnCorner = Instance.new("UICorner")
    CloseBtnCorner.CornerRadius = UDim.new(0, 8)
    CloseBtnCorner.Parent = CloseBtn

    local Content = Instance.new("Frame")
    Content.Name = "Content"
    Content.Size = UDim2.new(1, -48, 0, 310)
    Content.Position = UDim2.new(0, 24, 0, 80)
    Content.BackgroundTransparency = 1
    Content.Parent = MainFrame

    local InputContainer = Instance.new("Frame")
    InputContainer.Name = "InputContainer"
    InputContainer.Size = UDim2.new(1, 0, 0, 50)
    InputContainer.BackgroundColor3 = Colors.Secondary
    InputContainer.BorderSizePixel = 0
    InputContainer.Parent = Content

    local InputCorner = Instance.new("UICorner")
    InputCorner.CornerRadius = UDim.new(0, 12)
    InputCorner.Parent = InputContainer

    local InputStroke = Instance.new("UIStroke")
    InputStroke.Name = "Stroke"
    InputStroke.Color = Colors.Border
    InputStroke.Thickness = 1
    InputStroke.Parent = InputContainer

    local InputIcon = Instance.new("TextLabel")
    InputIcon.Name = "Icon"
    InputIcon.Size = UDim2.new(0, 44, 1, 0)
    InputIcon.BackgroundTransparency = 1
    InputIcon.Text = "üîë"
    InputIcon.TextSize = 16
    InputIcon.Font = Enum.Font.GothamMedium
    InputIcon.Parent = InputContainer

    local TextBox = Instance.new("TextBox")
    TextBox.Name = "KeyInput"
    TextBox.Size = UDim2.new(1, -54, 1, 0)
    TextBox.Position = UDim2.new(0, 44, 0, 0)
    TextBox.BackgroundTransparency = 1
    TextBox.Text = ""
    TextBox.PlaceholderText = "XXXX-XXXX-XXXX-XXXX"
    TextBox.PlaceholderColor3 = Colors.TextMuted
    TextBox.TextColor3 = Colors.Text
    TextBox.Font = Enum.Font.GothamMedium
    TextBox.TextSize = 14
    TextBox.TextXAlignment = Enum.TextXAlignment.Left
    TextBox.ClearTextOnFocus = false
    TextBox.BorderSizePixel = 0
    TextBox.Parent = InputContainer

    local ButtonsContainer = Instance.new("Frame")
    ButtonsContainer.Name = "Buttons"
    ButtonsContainer.Size = UDim2.new(1, 0, 0, 48)
    ButtonsContainer.Position = UDim2.new(0, 0, 0, 65)
    ButtonsContainer.BackgroundTransparency = 1
    ButtonsContainer.Parent = Content

    local GetKeyBtn = Instance.new("TextButton")
    GetKeyBtn.Name = "GetKeyBtn"
    GetKeyBtn.Size = UDim2.new(0.48, 0, 1, 0)
    GetKeyBtn.BackgroundColor3 = Colors.Secondary
    GetKeyBtn.BorderSizePixel = 0
    GetKeyBtn.Text = "üîë L·∫•y kh√≥a mi·ªÖn ph√≠ 24h"
    GetKeyBtn.TextColor3 = Colors.Text
    GetKeyBtn.Font = Enum.Font.GothamBold
    GetKeyBtn.TextSize = 12
    GetKeyBtn.Parent = ButtonsContainer

    local GetKeyCorner = Instance.new("UICorner")
    GetKeyCorner.CornerRadius = UDim.new(0, 12)
    GetKeyCorner.Parent = GetKeyBtn

    local ValidateBtn = Instance.new("TextButton")
    ValidateBtn.Name = "ValidateBtn"
    ValidateBtn.Size = UDim2.new(0.48, 0, 1, 0)
    ValidateBtn.Position = UDim2.new(0.52, 0, 0, 0)
    ValidateBtn.BackgroundColor3 = Colors.Primary
    ValidateBtn.BorderSizePixel = 0
    ValidateBtn.Text = "‚úì X√°c th·ª±c kh√≥a"
    ValidateBtn.TextColor3 = Colors.Text
    ValidateBtn.Font = Enum.Font.GothamBold
    ValidateBtn.TextSize = 12
    ValidateBtn.Parent = ButtonsContainer

    local ValidateCorner = Instance.new("UICorner")
    ValidateCorner.CornerRadius = UDim.new(0, 12)
    ValidateCorner.Parent = ValidateBtn

    local StatusContainer = Instance.new("Frame")
    StatusContainer.Name = "StatusContainer"
    StatusContainer.Size = UDim2.new(1, 0, 0, 40)
    StatusContainer.Position = UDim2.new(0, 0, 0, 125)
    StatusContainer.BackgroundColor3 = Colors.Secondary
    StatusContainer.BackgroundTransparency = 1
    StatusContainer.BorderSizePixel = 0
    StatusContainer.Parent = Content

    local StatusCorner = Instance.new("UICorner")
    StatusCorner.CornerRadius = UDim.new(0, 10)
    StatusCorner.Parent = StatusContainer

    local Status = Instance.new("TextLabel")
    Status.Name = "Status"
    Status.Size = UDim2.new(1, 0, 1, 0)
    Status.BackgroundTransparency = 1
    Status.Text = ""
    Status.TextColor3 = Colors.TextMuted
    Status.Font = Enum.Font.GothamMedium
    Status.TextSize = 13
    Status.TextWrapped = true
    Status.Parent = StatusContainer

    local SocialContainer = Instance.new("Frame")
    SocialContainer.Name = "SocialLinks"
    SocialContainer.Size = UDim2.new(1, 0, 0, 50)
    SocialContainer.Position = UDim2.new(0, 0, 0, 180)
    SocialContainer.BackgroundTransparency = 1
    SocialContainer.Parent = Content

    local SocialLabel = Instance.new("TextLabel")
    SocialLabel.Name = "Label"
    SocialLabel.Size = UDim2.new(1, 0, 0, 20)
    SocialLabel.BackgroundTransparency = 1
    SocialLabel.Text = "Ch√≠nh ch·ªß"
    SocialLabel.TextColor3 = Colors.TextMuted
    SocialLabel.Font = Enum.Font.GothamMedium
    SocialLabel.TextSize = 11
    SocialLabel.Parent = SocialContainer

    local FacebookBtn = Instance.new("ImageButton")
    FacebookBtn.Name = "FacebookBtn"
    FacebookBtn.Size = UDim2.new(0.30, 0, 0, 28)
    FacebookBtn.Position = UDim2.new(0, 0, 0, 22)
    FacebookBtn.BackgroundColor3 = Colors.Facebook
    FacebookBtn.BorderSizePixel = 0
    FacebookBtn.Image = "rbxasset://textures/Cursor.png"
    FacebookBtn.Parent = SocialContainer

    local FbCorner = Instance.new("UICorner")
    FbCorner.CornerRadius = UDim.new(0, 10)
    FbCorner.Parent = FacebookBtn

    local FbLabel = Instance.new("TextLabel")
    FbLabel.Size = UDim2.new(1, 0, 1, 0)
    FbLabel.BackgroundTransparency = 1
    FbLabel.Text = "üìò Facebook"
    FbLabel.TextColor3 = Colors.Text
    FbLabel.Font = Enum.Font.GothamBold
    FbLabel.TextSize = 12
    FbLabel.Parent = FacebookBtn

    local DiscordBtn = Instance.new("ImageButton")
    DiscordBtn.Name = "DiscordBtn"
    DiscordBtn.Size = UDim2.new(0.30, 0, 0, 28)
    DiscordBtn.Position = UDim2.new(0.35, 0, 0, 22)
    DiscordBtn.BackgroundColor3 = Colors.Discord
    DiscordBtn.BorderSizePixel = 0
    DiscordBtn.Image = "rbxasset://textures/Cursor.png"
    DiscordBtn.Parent = SocialContainer

    local DisCorner = Instance.new("UICorner")
    DisCorner.CornerRadius = UDim.new(0, 10)
    DisCorner.Parent = DiscordBtn

    local DisLabel = Instance.new("TextLabel")
    DisLabel.Size = UDim2.new(1, 0, 1, 0)
    DisLabel.BackgroundTransparency = 1
    DisLabel.Text = "üéÆ Discord"
    DisLabel.TextColor3 = Colors.Text
    DisLabel.Font = Enum.Font.GothamBold
    DisLabel.TextSize = 12
    DisLabel.Parent = DiscordBtn

    local FreeKeyBtn = Instance.new("ImageButton")
    FreeKeyBtn.Name = "FreeKeyBtn"
    FreeKeyBtn.Size = UDim2.new(0.30, 0, 0, 28)
    FreeKeyBtn.Position = UDim2.new(0.70, 0, 0, 22)
    FreeKeyBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
    FreeKeyBtn.BorderSizePixel = 0
    FreeKeyBtn.Image = "rbxasset://textures/Cursor.png"
    FreeKeyBtn.Parent = SocialContainer

    local FreeCorner = Instance.new("UICorner")
    FreeCorner.CornerRadius = UDim.new(0, 10)
    FreeCorner.Parent = FreeKeyBtn

    local FreeLabel = Instance.new("TextLabel")
    FreeLabel.Size = UDim2.new(1, 0, 1, 0)
    FreeLabel.BackgroundTransparency = 1
    FreeLabel.Text = "C·∫£m ∆°n"
    FreeLabel.TextColor3 = Colors.Text
    FreeLabel.Font = Enum.Font.GothamBold
    FreeLabel.TextSize = 12
    FreeLabel.Parent = FreeKeyBtn

    local Footer = Instance.new("TextLabel")
    Footer.Name = "Footer"
    Footer.Size = UDim2.new(1, 0, 0, 20)
    Footer.Position = UDim2.new(0, 0, 1, -30)
    Footer.BackgroundTransparency = 1
    Footer.Text = "ƒê∆∞·ª£c b·∫£o m·∫≠t b·ªüi PandaDevelopment!"
    Footer.TextColor3 = Color3.fromRGB(80, 80, 100)
    Footer.Font = Enum.Font.GothamMedium
    Footer.TextSize = 10
    Footer.Parent = MainFrame

    -- ANIMATIONS
    local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quint, Enum.EasingDirection.Out)
    local fastTween = TweenInfo.new(0.25, Enum.EasingStyle.Quint, Enum.EasingDirection.Out)

    local function PlayIntro()
        MainFrame.Position = UDim2.new(0.5, -202, 0.566, -220)
        TweenService:Create(Overlay, tweenInfo, {BackgroundTransparency = 0.7}):Play()
        TweenService:Create(Blur, tweenInfo, {Size = 12}):Play()
        TweenService:Create(MainFrame, tweenInfo, {
            BackgroundTransparency = 0,
            Position = UDim2.new(0.5, -202, 0.516, -220)
        }):Play()
        TweenService:Create(MainStroke, tweenInfo, {Transparency = 0}):Play()
    end

    local function PlayOutro()
        local outroTween = TweenInfo.new(0.4, Enum.EasingStyle.Quint, Enum.EasingDirection.In)
        TweenService:Create(Overlay, outroTween, {BackgroundTransparency = 1}):Play()
        TweenService:Create(Blur, outroTween, {Size = 0}):Play()
        local mainTween = TweenService:Create(MainFrame, outroTween, {
            BackgroundTransparency = 1,
            Position = UDim2.new(0.5, -202, 0.45, -220)
        })
        mainTween:Play()
        mainTween.Completed:Wait()
        Blur:Destroy()
        ScreenGui:Destroy()
        guiCreated = false
    end

    local function AddButtonHover(button, hoverColor, originalColor)
        button.MouseEnter:Connect(function()
            TweenService:Create(button, fastTween, {BackgroundColor3 = hoverColor}):Play()
        end)
        button.MouseLeave:Connect(function()
            TweenService:Create(button, fastTween, {BackgroundColor3 = originalColor}):Play()
        end)
    end

    AddButtonHover(GetKeyBtn, Colors.SecondaryHover, Colors.Secondary)
    AddButtonHover(ValidateBtn, Colors.PrimaryHover, Colors.Primary)
    AddButtonHover(FacebookBtn, Color3.fromRGB(44, 139, 255), Colors.Facebook)
    AddButtonHover(DiscordBtn, Color3.fromRGB(108, 121, 255), Colors.Discord)
    AddButtonHover(FreeKeyBtn, Color3.fromRGB(54, 217, 114), Color3.fromRGB(34, 197, 94))

    TextBox.Focused:Connect(function()
        TweenService:Create(InputStroke, fastTween, {Color = Colors.Primary}):Play()
    end)

    TextBox.FocusLost:Connect(function()
        TweenService:Create(InputStroke, fastTween, {Color = Colors.Border}):Play()
    end)

    CloseBtn.MouseEnter:Connect(function()
        TweenService:Create(CloseBtn, fastTween, {
            BackgroundTransparency = 0,
            ImageColor3 = Colors.Error
        }):Play()
    end)

    CloseBtn.MouseLeave:Connect(function()
        TweenService:Create(CloseBtn, fastTween, {
            BackgroundTransparency = 1,
            ImageColor3 = Colors.Text
        }):Play()
    end)

    -- DRAG FUNCTIONALITY
    local dragging, dragInput, dragStart, startPos

    MainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    MainFrame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            TweenService:Create(MainFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quint), {
                Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            }):Play()
        end
    end)

    -- BUTTON CLICK EVENTS
    CloseBtn.MouseButton1Click:Connect(function()
        PlayOutro()
    end)

    GetKeyBtn.MouseButton1Click:Connect(function()
        local hwid = LocalPlayer.UserId
        local link = GetKeyLink(ServiceIdentifier, hwid)
        
        pcall(function()
            setclipboard(link)
        end)
        
        StatusContainer.BackgroundTransparency = 0
        StatusContainer.BackgroundColor3 = Color3.fromRGB(34, 60, 45)
        Status.TextColor3 = Colors.Success
        Status.Text = "‚úì ƒê√£ sao ch√©p li√™n k·∫øt Kho√° 24h!"
        
        task.delay(3, function()
            if Status.Text == "‚úì ƒê√£ sao ch√©p li√™n k·∫øt Kho√° 24h!" then
                TweenService:Create(StatusContainer, fastTween, {BackgroundTransparency = 1}):Play()
                Status.Text = ""
            end
        end)
    end)

    FacebookBtn.MouseButton1Click:Connect(function()
        pcall(function()
            setclipboard("https://www.facebook.com/pandadevelopment")
        end)
        Status.Text = "‚úì ƒê√£ sao ch√©p li√™n k·∫øt Facebook!"
        StatusContainer.BackgroundTransparency = 0
        StatusContainer.BackgroundColor3 = Color3.fromRGB(24, 60, 100)
        Status.TextColor3 = Colors.Facebook
        
        task.delay(2, function()
            TweenService:Create(StatusContainer, fastTween, {BackgroundTransparency = 1}):Play()
        end)
    end)

    DiscordBtn.MouseButton1Click:Connect(function()
        pcall(function()
            setclipboard("https://discord.gg/pandadevelopment")
        end)
        Status.Text = "‚úì ƒê√£ sao ch√©p li√™n k·∫øt Discord!"
        StatusContainer.BackgroundTransparency = 0
        StatusContainer.BackgroundColor3 = Color3.fromRGB(50, 60, 100)
        Status.TextColor3 = Colors.Discord
        
        task.delay(2, function()
            TweenService:Create(StatusContainer, fastTween, {BackgroundTransparency = 1}):Play()
        end)
    end)

    FreeKeyBtn.MouseButton1Click:Connect(function()
        pcall(function()
            setclipboard("C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng!")
        end)
        Status.Text = "‚úì C·∫£m ∆°n!"
        StatusContainer.BackgroundTransparency = 0
        StatusContainer.BackgroundColor3 = Color3.fromRGB(34, 60, 45)
        Status.TextColor3 = Colors.Success
        
        task.delay(2, function()
            TweenService:Create(StatusContainer, fastTween, {BackgroundTransparency = 1}):Play()
        end)
    end)

    ValidateBtn.MouseButton1Click:Connect(function()
        local key = TextBox.Text
        
        if key == "" or key:match("^%s*$") then
            StatusContainer.BackgroundTransparency = 0
            StatusContainer.BackgroundColor3 = Color3.fromRGB(60, 35, 35)
            Status.TextColor3 = Colors.Error
            Status.Text = "‚úï Vui l√≤ng nh·∫≠p kh√≥a"
            return
        end
        
        StatusContainer.BackgroundTransparency = 1
        Status.Text = ""
        
        local valid, msg = ValidateKey(key, ServiceIdentifier, LocalPlayer.UserId)
        
        if valid then
            storedKey = key
            SaveConfig(key)
            
            StatusContainer.BackgroundTransparency = 0
            StatusContainer.BackgroundColor3 = Color3.fromRGB(34, 60, 45)
            Status.TextColor3 = Colors.Success
            Status.Text = "‚úì ƒê√£ c·∫•p quy·ªÅn truy c·∫≠p!"
            
            TweenService:Create(InputStroke, fastTween, {Color = Colors.Success}):Play()
            
            task.wait(1.5)
            PlayOutro()
            
            task.wait(0.2)
            pcall(function()
                loadstring(game:HttpGet("https://pandadevelopment.net/virtual/file/deec6f23374c6a89"))()
            end)
            
        else
            StatusContainer.BackgroundTransparency = 0
            StatusContainer.BackgroundColor3 = Color3.fromRGB(60, 35, 35)
            Status.TextColor3 = Colors.Error
            Status.Text = "‚úï Kh√≥a kh√¥ng h·ª£p l·ªá"
            
            local originalPos = MainFrame.Position
            for i = 1, 3 do
                TweenService:Create(MainFrame, TweenInfo.new(0.05), {
                    Position = UDim2.new(originalPos.X.Scale, originalPos.X.Offset + 5, originalPos.Y.Scale, originalPos.Y.Offset)
                }):Play()
                task.wait(0.05)
                TweenService:Create(MainFrame, TweenInfo.new(0.05), {
                    Position = UDim2.new(originalPos.X.Scale, originalPos.X.Offset - 5, originalPos.Y.Scale, originalPos.Y.Offset)
                }):Play()
                task.wait(0.05)
            end
            TweenService:Create(MainFrame, TweenInfo.new(0.05), {Position = originalPos}):Play()
            
            TweenService:Create(InputStroke, fastTween, {Color = Colors.Error}):Play()
            task.delay(2, function()
                TweenService:Create(InputStroke, fastTween, {Color = Colors.Border}):Play()
            end)
        end
    end)

    task.wait(1.5)
    if LoadingScreen.Parent then
        LoadingScreen:Destroy()
    end

    local savedConfig = LoadConfig()
    if savedConfig and savedConfig.Key then
        TextBox.Text = savedConfig.Key
    end

    PlayIntro()
end

-- === INITIALIZE ===
CreateUI()

-- === DETECT CHARACTER RESET ===
local function OnCharacterRespawn()
    task.wait(0.5)
    if guiCreated then
        CreateUI()
    end
end

if LocalPlayer.Character then
    LocalPlayer.CharacterAdded:Connect(OnCharacterRespawn)
end
